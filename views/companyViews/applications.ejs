<div class="container my-5">
  <h3 class="mb-4 text-center">
    Applications for <strong><%= posting.title %></strong>
  </h3>

  <% if (applications.length === 0) { %>
    <div class="text-center text-muted my-5">
      <i class="bi bi-inbox display-6 d-block mb-3"></i>
      <h5>No applications available currently</h5>
    </div>
  <% } else { %>

  <div class="table-responsive">
    <table class="table table-hover align-middle shadow-sm">
      <thead class="table-light">
        <tr>
          <th>Applicant ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% for (const appl of applications) { 
          let badgeClass, disableClass;
          switch (appl.status) {
            case 'Applied': badgeClass='secondary'; break;
            case 'TestGiven': badgeClass='info'; break;
            case 'Rejected': badgeClass='danger'; break;
            case 'Shortlisted': badgeClass='success'; break;
            default: badgeClass='secondary';
          }

          disableClass = (appl.status === 'Rejected') ? 'disabled' : '';

          const studentIdStr = appl.studentId._id.toString();

          const alreadyPlacedElsewhere = placedStudents.has(studentIdStr);
          const selectedByCurrentCompany = selectedStudents.has(studentIdStr);

          const interviewRejected = appl.interview && appl.interview.result === 'Rejected';

          let rowClass = '';
          if (selectedByCurrentCompany) rowClass = 'table-success';
          else if (alreadyPlacedElsewhere) rowClass = 'table-warning';
          else if (interviewRejected) rowClass = 'table-secondary text-muted'; // grey out rejected
        %>

          <tr class="<%= rowClass %>">
            <td><%= appl.studentId._id %></td>
            <td><%= appl.studentId.name %></td>
            <td><%= appl.studentId.email %></td>
            <td>
              <span class="badge text-bg-<%= badgeClass %>"><%= appl.status %></span>
            </td>
            <td>
              <% if (selectedByCurrentCompany) { %>
                <button class="btn btn-sm btn-success disabled">
                  <i class="bi bi-trophy me-1"></i> Selected
                </button>
              <% } else if (alreadyPlacedElsewhere) { %>
                <button class="btn btn-sm btn-secondary disabled">
                  <i class="bi bi-lock me-1"></i> Placed Elsewhere
                </button>
              <% } else if (interviewRejected) { %>
                <button class="btn btn-sm btn-secondary disabled">
                  <i class="bi bi-x-circle me-1"></i> Rejected
                </button>
              <% } else { %>
                <a href="/api/company/<%= company._id %>/postings/<%= posting._id %>/applications/<%= appl._id %>"
                   class="btn btn-sm btn-primary <%= disableClass %>">
                  <i class="bi bi-eye me-1"></i> View Applicant
                </a>
              <% } %>
            </td>
          </tr>

        <% } %>
      </tbody>
    </table>
  </div>
  <% } %>
</div>
